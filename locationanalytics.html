<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wake County Map</title>
    <!-- Leaflet CSS for map styling -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <!-- Tailwind CSS for modern, responsive styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter font for clean typography -->
    <style>
        body {
            font-family: "Inter", sans-serif;
        }

        /* Basic styling for the map container */
        #map-container {
            height: 500px;
            margin: 20px;
            border: 2px solid #ddd;
            border-radius: 8px;
            overflow: hidden; /* Ensures the map stays within its container's rounded corners */
        }

        #map {
            width: 100%;
            height: 100%;
        }

        /* Styling for the custom message box with a fade transition */
        #message-box {
            transition: opacity 0.3s ease-in-out;
        }

        /* Use a utility class to control visibility with opacity */
        .is-visible {
            opacity: 1;
            pointer-events: auto;
        }

        /* Keep hidden class for initial state, but use opacity for effect */
        .hidden {
            opacity: 0;
            pointer-events: none;
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col items-center justify-start min-h-screen p-4">

    <!-- Main header with a bit of style -->
    <h1 class="text-3xl font-bold text-gray-800 mb-6">Wake County Geo-Fencing App</h1>

    <div id="map-container" class="w-full max-w-4xl shadow-lg rounded-xl">
        <!-- The map will be rendered here -->
        <div id="map"></div>
    </div>

    <!-- Custom message box to replace alert() -->
    <div id="message-box" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl text-center max-w-sm mx-auto">
            <p id="message-text" class="text-lg font-semibold text-gray-800 mb-4"></p>
            <button id="close-button" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors">
                Close
            </button>
        </div>
    </div>

    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-ajax/dist/leaflet.ajax.min.js"></script>
    <script src="https://unpkg.com/@turf/turf@6.3.0/turf.min.js"></script>

    <script>
        // Use window.onload to ensure all elements are loaded before running the script
        window.onload = function() {
            // Initialize the map centered on Wake County, North Carolina
            const map = L.map('map').setView([35.77603969549853, -78.63832970038803], 12);

            // Add a base tile layer from OpenStreetMap
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors'
            }).addTo(map);

            // Get references to the custom message box elements
            const messageBox = document.getElementById('message-box');
            const messageText = document.getElementById('message-text');
            const closeButton = document.getElementById('close-button');

            // Function to show the custom message box
            function showCustomMessage(message) {
                messageText.textContent = message;
                messageBox.classList.add('is-visible');
                messageBox.classList.remove('hidden');
            }

            // Hide the message box when the close button is clicked
            closeButton.addEventListener('click', () => {
                messageBox.classList.remove('is-visible');
                // Use a timeout to fully hide the element after the transition is complete
                setTimeout(() => {
                    messageBox.classList.add('hidden');
                }, 300);
            });

            // Load the GeoJSON file containing the polygon
            const geojsonLayer = new L.GeoJSON.AJAX('https://raw.githubusercontent.com/stevenfhill/earth-fair/main/school_buffer.json', {
                onEachFeature: function(feature, layer) {
                    // You can add styling or popups here for the GeoJSON layer if needed
                }
            });

            // Add the GeoJSON layer to the map when it is loaded
            geojsonLayer.on('data:loaded', function() {
                geojsonLayer.addTo(map);

                // Try to get the user's current location after the GeoJSON data has loaded
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        function(position) {
                            const userLatLng = L.latLng(position.coords.latitude, position.coords.longitude);

                            // Add a marker for the user's location
                            L.marker(userLatLng).addTo(map)
                                .bindPopup("You are here!").openPopup();

                            // Center the map on the user's location with a close zoom level
                            map.setView(userLatLng, 15);

                            // Convert the Leaflet GeoJSON layer to a Turf.js FeatureCollection
                            const featureCollection = geojsonLayer.toGeoJSON();

                            // Check if the user is inside ANY of the polygons
                            let isInsideAny = false;
                            featureCollection.features.forEach(feature => {
                                if (turf.booleanPointInPolygon(turf.point([userLatLng.lng, userLatLng.lat]), feature.geometry)) {
                                    isInsideAny = true;
                                }
                            });

                            if (isInsideAny) {
                                showCustomMessage("you are a creep");
                            } else {
                                showCustomMessage("go to go man");
                            }
                        },
                        function(error) {
                            // Handle geolocation errors gracefully
                            console.error("Geolocation error:", error);
                            showCustomMessage("Geolocation failed: " + error.message);
                        }
                    );
                } else {
                    // Handle the case where the browser does not support geolocation
                    showCustomMessage("Geolocation is not supported by your browser.");
                }
            });
        };
    </script>
</body>
</html>
